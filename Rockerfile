FROM aidbox/postgrespro-plv8:9.6.1.2-1.5.5

ENV FHIRPATH_VERSION 3f179730b37db75aede5b07f9cd9c439d44c7a15

RUN	cd /usr/src/postgresql/contrib \
  && git clone https://github.com/niquola/fhirpath-pg  \
	&& cd fhirpath-pg \
  && git checkout $FHIRPATH_VERSION \ 
	&& make && make install

EXPORT /pg
EXPORT /usr/lib/libv8.so libv8.so

ENV GOSU_VERSION 1.9

RUN set -x \
    && apt-get update && apt-get install -y --no-install-recommends ca-certificates wget && rm -rf /var/lib/apt/lists/* \
    && dpkgArch="$(dpkg --print-architecture | awk -F- '{ print $NF }')" \
    && wget -O /usr/local/bin/gosu "https://github.com/tianon/gosu/releases/download/$GOSU_VERSION/gosu-$dpkgArch" \
    && wget -O /usr/local/bin/gosu.asc "https://github.com/tianon/gosu/releases/download/$GOSU_VERSION/gosu-$dpkgArch.asc" \
    && export GNUPGHOME="$(mktemp -d)" \
    && gpg --keyserver ha.pool.sks-keyservers.net --recv-keys B42F6819007F00F88E364FD4036A9C25BF357DD4 \
    && gpg --batch --verify /usr/local/bin/gosu.asc /usr/local/bin/gosu \
    && rm -r "$GNUPGHOME" /usr/local/bin/gosu.asc \
    && chmod +x /usr/local/bin/gosu \
    && gosu nobody true \
    && apt-get purge -y --auto-remove ca-certificates wget

EXPORT /usr/local/bin/gosu  gosu

FROM debian:jessie

IMPORT /pg
IMPORT libv8.so /usr/lib/libv8.so
IMPORT gosu /usr/local/bin/gosu

RUN apt-get update

RUN apt-get install -y locales libssl1.0.0

RUN localedef --force --inputfile=en_US --charmap=UTF-8 \
    --alias-file=/usr/share/locale/locale.alias \
    en_US.UTF-8

ENV LANG en_US.utf8

RUN groupadd -r postgres --gid=999 && useradd -r -g postgres --uid=999 postgres
RUN mkdir /data && chown postgres:postgres /data

ENV PATH /pg/bin:$PATH
ENV PGDATA /data

COPY docker-entrypoint.sh /

VOLUME /data

ENTRYPOINT ["/docker-entrypoint.sh"]

EXPOSE 5432

CMD ["postgres"]

PUSH aidbox/aidboxdb:{{ .Version }}
